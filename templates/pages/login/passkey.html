{#
Copyright 2025 New Vector Ltd.

SPDX-License-Identifier: AGPL-3.0-only
Please see LICENSE in the repository root for full details.
-#}

{% extends "base.html" %}

{% set params = next["params"] | default({}) | to_params(prefix="?") %}

{% block content %}
  <noscript class="fullscreen-noscript">
    <main class="flex flex-col gap-6 layout-container">
      <header class="page-heading">
        <div class="icon invalid">
          {{ icon.error_solid() }}
        </div>

        <div class="header">
          <h1 class="title">{{ _("mas.errors.passkey_no_js_title") }}</h1>
            <p class="text">
              {{ _("mas.errors.passkey_no_js_description") }}
            </p>
        </div>
      </header>

      {{ button.link_outline(text=_("action.back"), href="/login" ~ params) }}
    </main>
  </noscript>

  <form method="POST" class="flex flex-col gap-10" id="passkey-form">
    <header class="page-heading">
      <div class="icon">
        {{ icon.user_profile_solid() }}
      </div>

      <div class="header">
        <h1 class="title">{{ _("mas.login.headline") }}</h1>
        <p class="text">{{ _("mas.login.passkey_description") }}</p>
      </div>
    </header>

    <div class="cpd-form-root">
      <div id="errors">
        {% if form.errors is not empty %}
          {% for error in form.errors %}
            <div class="text-critical font-medium">
              {{ errors.form_error_message(error=error) }}
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <input type="hidden" name="csrf" value="{{ csrf_token }}" />

      {% call(f) field.field(name="id", form_state=form) %}
        <input {{ field.attributes(f) }} class="cpd-text-control" type="hidden" />
      {% endcall %}

      {% call(f) field.field(name="response", form_state=form) %}
        <input {{ field.attributes(f) }} class="cpd-text-control" type="hidden" />
      {% endcall %}
    </div>
  </form>

  <div class="hidden" id="retry-button-container">
    {{ button.button(text=_("action.try_again"), id="retry-button") }}
  </div>

  {{ button.link_outline(text=_("action.back"), href="/login" ~ params) }}

  <script>
    window.WEBAUTHN_OPTIONS = "{{ options | add_slashes | safe }}";
  </script>
  {{ include_asset('src/template_passkey.ts') | indent(4) | safe }}
{% endblock content %}
